{% extends "documents/base.html" %}

{% block content %}

    <article id="document">
        <header role="banner" id="banner">
            {% block tools %}
                <nav class="tools">
                    <ul>
                        <li><a href="#" class="new-entity">New entity</a></li>
                        <li><a href="#export-list" data-toggle="true" class="export">Export</a></li>
                        <li><a href="#" class="save-document">Save</a></li>
                    </ul>
                </nav>
            {% endblock %}
            <h1 class="{% if edit %}edit-title{% endif %}">{{ document.title }}</h1>
            <nav class="leave">
                {% block nav %}
                    <ul>
                        <li><a href="{% url my_documents %}">Back to list</a></li>
                    </ul>
                {% endblock %}
            </nav>

        </header>

        <div id="entities"></div>

        <div id="notifications"></div>

        <ul id="export-list">
            {% for key, label in exporters %}
                <li><a target="_blank" href="{% url export_document document.pk key %}">{{ label }}</a></li>
            {% endfor %}
        </ul>

    </article>


    <!-- templates -->

    {% block app %}


        <script type="text/html" id="attribute-form-template">
            <form action="#" class="attribute-form">
                <p>
                    <label for="name">Name</label>
                    <input type="text" name="name" id="name">
                </p>

                <p>
                    <label for="type">Type</label>
                    <select name="type" id="type">
                        {% for type, label in FIELD_TYPES %}
                        <option value="{{ type }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </p>

                <p>
                    <input type="checkbox" name="is_primary_key" value="true" id="is_primary_key">
                    <label for="is_primary_key"> Primary key</label>
                </p>

                <p>
                    <input type="checkbox" name="is_foreign_key" value="true" id="is_foreign_key">
                    <label for="is_foreign_key">Foreign key</label>
                </p>

                <p class="foreign-key-details">
                    <label for="name">Entity</label>
                    <input type="text" name="foreign_key_entity" id="foreign_key_entity">
                </p>

                <p class="foreign-key-details">
                    <label for="name">Attribute</label>
                    <input type="text" name="foreign_key_attribute" id="foreign_key_attribute">
                </p>


                <input type="submit" class="anchor save" value="Save" >
                <input type="button" class="anchor close" value="Close" >

            </form>
        </script>

        <script type="text/html" id="attribute-list-template">
            <section class="attributes"></section>
            {% if edit %}<a href="#" class="action new-attribute">new attribute</a>{% endif %}
        </script>

        <script type="text/html" id="attribute-template">
            <a href="#" class="name {% if edit %}edit{% endif %}"><%= name %> <span><%= type %></span></a>
            {% if edit %}<a href="#" class="remove-attribute" title="remove attribute">delete</a>{% endif %}
        </script>

        <script type="text/html" id="entity-template">
            <header>
                <h3><%= name %></h3>
            </header>
            <section class="attributes"></section>

            <footer>
                {% if edit %}<a href="#" class="action remove-entity">remove entity</a>{% endif %}
            </footer>

        </script>

        <script type="text/html" id="dialog-template">
        <h3><%= title %></h3>
        </script>

{% endblock %}

{% endblock %}


{% block scripts %}

    {{ block.super }}

    <script type="text/javascript">
        // underscore.string mixin
        _.mixin(_.string.exports());
    </script>

    <!-- namespaces -->
    <script type="text/javascript">
        var dbpatterns = {
            models: {},
            collections: {},
            views: {},
            notifications: {}
        };
        _.extend(dbpatterns.notifications, Backbone.Events);
    </script>

    <!-- application -->
    <script src="{{ STATIC_URL }}js/views/ui.js"></script>
    <script src="{{ STATIC_URL }}js/models/document.js"></script>
    <script src="{{ STATIC_URL }}js/models/entity.js"></script>
    <script src="{{ STATIC_URL }}js/views/document.js"></script>
    <script src="{{ STATIC_URL }}js/views/entity.js"></script>
    <script src="{{ STATIC_URL }}js/views/attribute.js"></script>
    <script src="{{ STATIC_URL }}js/views/connection.js"></script>
    <script src="{{ STATIC_URL }}js/views/notifier.js"></script>
    <script src="{{ STATIC_URL }}js/models/attribute.js"></script>
    <script src="{{ STATIC_URL }}js/utils/tastypie.js"></script>

    <!-- bootstrap -->
    <script type="text/javascript">
        $(function () {

            // load notifier view.
            new dbpatterns.views.Notifier();

            // create a new document instance with resource uri.
            var document = new dbpatterns.models.Document({
                "resource_uri": "{{ document.get_resource_uri }}"
            });

            // load document view.
            new dbpatterns.views.Document({
                "model": document,
                "edit": "{{ edit|yesno:"true,false" }}"
            });

            // retrieve document by the provided resource uri.
            document.fetch();

        });
    </script>
{% endblock %}